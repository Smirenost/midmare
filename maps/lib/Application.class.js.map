{"version":3,"sources":["lib/Application.class.js","../lib/Application.class.ts"],"names":["Object","defineProperty","exports","value","Application","Router_class_1","require","Context_class_1","Application_1","[object Object]","options","this","__initialized","middleware","helpers","create","__timeout","appTimeout","setTimeout","router","Router","context","Context","app","withListen","listen","init","handler","reload","use","routes","assign","clearTimeout","ctx","fnWare","catch","error","path","mw","createCompose","data","newCtx","createContext","__pathStory","add","key","hasOwnProperty","filter","m","restore","store","set","execute","args","process","fn","TypeError","push","callback","Error","name","bind","arrFn","Array","isArray","some","item","next","index","exec","i","Promise","reject","length","clear","resolve","ignoreCyclicError","has","concat","err"],"mappings":"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","file":"../../lib/Application.class.js","sourcesContent":["\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.Application=void 0;const Router_class_1=require(\"./Router.class\"),Context_class_1=require(\"./Context.class\");var Application;!function(t){class e{constructor(t={}){this.options=t,this.__initialized=!1,this.middleware=[],this.helpers=Object.create(null),this.__timeout=()=>{this.appTimeout=setTimeout(this.__timeout,1e9)},this.router=new Router_class_1.Router.Router({}),this.context=new Context_class_1.Context.Context({app:this}),t.withListen&&(this.listen=this.init)}init(){if(!this.__initialized)return this.handler||this.reload(),this.use(this.router.routes()),Object.assign(this.context,this.helpers),this.__initialized=!0,this.listen&&(this.appTimeout=setTimeout(this.__timeout,1e9)),this}stop(){clearTimeout(this.appTimeout)}execute(t,e){e(t).catch(t.error)}createContext(t){return this.context=Object.assign(Object.create(this.context),{path:t,app:this}),Object.create(this.context)}callback(){let t=e.createCompose(this.middleware);return(r,i,s)=>{const o=this.createContext(r);if(s){s.__pathStory.add(s.path);for(let t in s)s.hasOwnProperty(t)&&(o[t]=s[t]);t=e.createCompose(this.middleware.filter(t=>!!t.router)),o.restore(s.store())}o.set(\"data\",i),this.execute(o,t)}}process(...t){return this.router.process(...t),this}use(t){if(\"function\"!=typeof t)throw new TypeError(\"middleware must be a function.\");return this.middleware.push(t),this}reload(){return this.handler=this.callback(),this}send(t,e,r){if(!this.handler||!this.__initialized)throw new Error(\"Application is not initialized.\");return this.handler(t,e,r),this}helper(t,e){if(!t.name)throw new Error(\"Helper must be named FunctionDeclaration.\");if(\"function\"==typeof this.helpers[t.name])throw new Error(\"Helper with this named already declared.\");return this.helpers[t.name]=e?t.bind(e):t,this}static createCompose(t){if(!Array.isArray(t))throw new TypeError(\"Argument should be an array\");if(t.some(t=>\"function\"!=typeof t))throw new TypeError(\"Collection should be an array of functions.\");return function(e,r){let i=-1;return function s(o){if(o<=i)return Promise.reject(new Error(\"Function next() called multiple times\"));i=o;let n=t[o];o===t.length&&(n=r);if(!n)return e.__pathStory.clear(),Promise.resolve();try{if(!e.app.options.ignoreCyclicError&&e.__pathStory.has(e.path))throw new Error(\"Cyclic calling with same `path`: `\".concat(e.path,\"`, be careful\"));const t=s.bind(null,o+1);return e.next=t,Promise.resolve(n(e,t))}catch(t){return e.__pathStory.clear(),Promise.reject(t)}}(0)}}}t.Application=e}(Application=exports.Application||(exports.Application={}));\n//# sourceMappingURL=../maps/lib/Application.class.js.map\n","import {Router} from \"./Router.class\";\nimport {Context} from \"./Context.class\";\nimport {Middleware} from \"./Middleware.class\";\n\nexport namespace Application {\n    import Path = Router.Path;\n\n    export interface Helper {\n        (...args: any[]): any;\n        name: string;\n    }\n\n    export class Application {\n        protected __initialized: boolean = false;\n        protected context: Context.Context;\n        protected readonly router: Router.Router;\n        protected readonly middleware: Middleware.Middleware[] = [];\n        protected handler: (path: Path, data: any, ctx?: Context.Context) => void;\n        protected appTimeout: NodeJS.Timeout;\n        protected helpers: NodeJS.Dict<Helper> = Object.create(null);\n        public readonly listen: Function;\n\n        constructor(public readonly options: IOptions = {}) {\n            this.router = new Router.Router({} as Router.IOptions);\n            this.context = new Context.Context({ app: this });\n            if(options.withListen) {\n                this.listen = this.init;\n            }\n        }\n\n        public init() {\n            if(this.__initialized) return;\n            if(!this.handler) this.reload();\n            this.use(this.router.routes());\n            Object.assign(this.context, this.helpers);\n            this.__initialized = true;\n\n            if(this.listen) {\n                this.appTimeout = setTimeout(this.__timeout,1000000000);\n            }\n\n            return this;\n        }\n\n        public stop() {\n            clearTimeout(this.appTimeout);\n        }\n\n        protected __timeout = () => {\n            this.appTimeout = setTimeout(this.__timeout,1000000000);\n        };\n\n        protected execute(ctx: Context.Context, fnWare) {\n            fnWare(ctx).catch(ctx.error);\n        }\n\n        protected createContext(path: Path) {\n            this.context = Object.assign(\n                Object.create(this.context),\n                {\n                    path,\n                    app: this\n                }\n            );\n\n            return Object.create(this.context);\n        }\n\n        protected callback() {\n            let mw = Application.createCompose(this.middleware);\n\n            return (path: Path, data: any, context: Context.Context) => {\n                const newCtx = this.createContext(path);\n\n                if (context) {\n                    context.__pathStory.add(context.path);\n\n                    for(let key in context) {\n                        if(context.hasOwnProperty(key)) {\n                            newCtx[key] = context[key];\n                        }\n                    }\n\n                    mw = Application.createCompose(this.middleware.filter(m => !!m.router));\n                    newCtx.restore(context.store());\n                }\n\n                newCtx.set('data', data);\n                this.execute(newCtx, mw);\n            };\n        }\n\n        public process(...args) {\n            this.router.process(...args);\n            return this;\n        }\n\n        public use(fn) {\n            if (typeof fn !== 'function') throw new TypeError('middleware must be a function.');\n            this.middleware.push(fn);\n            return this;\n        }\n\n        public reload() {\n            this.handler = this.callback();\n            return this;\n        }\n\n        public send(path: Path, data, ctx?: Context.Context) {\n            if (!this.handler || !this.__initialized) throw new Error('Application is not initialized.');\n\n            this.handler(path, data, ctx);\n            return this;\n        }\n\n\n        public helper(callback: Helper, context?: any) {\n            if(!callback.name) throw new Error('Helper must be named FunctionDeclaration.');\n            if(typeof this.helpers[callback.name] === 'function') throw new Error('Helper with this named already declared.');\n            this.helpers[callback.name] = !context ? callback : callback.bind(context);\n            return this;\n        }\n\n\n        public static createCompose(arrFn) {\n            if (!Array.isArray(arrFn)) throw new TypeError('Argument should be an array');\n            if (arrFn.some(item => typeof item !== 'function'))\n                throw new TypeError('Collection should be an array of functions.');\n\n            return function (context, next) {\n                let index = -1;\n                return exec(0);\n\n                function exec(i) {\n                    if (i <= index) return Promise.reject(new Error('Function next() called multiple times'));\n                    index = i;\n                    let fn = arrFn[i];\n                    if (i === arrFn.length) fn = next;\n                    if (!fn) {\n                        context.__pathStory.clear();\n                        return Promise.resolve();\n                    }\n                    try {\n                        if(!context.app.options.ignoreCyclicError && context.__pathStory.has(context.path))\n                            throw new Error('Cyclic calling with same `path`: `'.concat(context.path, '`, be careful'));\n                        const next = exec.bind(null, i + 1);\n                        context.next = next;\n                        return Promise.resolve(fn(context, next));\n                    } catch (err) {\n                        context.__pathStory.clear();\n                        return Promise.reject(err);\n                    }\n                }\n            }\n        }\n    }\n\n    export interface IOptions {\n        withListen?: boolean;\n        ignoreCyclicError?: boolean;\n    }\n}"]}