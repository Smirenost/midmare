"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Application=void 0;const Router_class_1=require("./Router.class"),Context_class_1=require("./Context.class");var Application;!function(t){class e{constructor(t={}){this.options=t,this.__initialized=!1,this.middleware=[],this.helpers=Object.create(null),this.__timeout=()=>{this.appTimeout=setTimeout(this.__timeout,1e9)},this.router=new Router_class_1.Router.Router({}),this.context=new Context_class_1.Context.Context({app:this}),t.withListen&&(this.listen=this.init)}init(){if(!this.__initialized)return this.handler||this.reload(),this.use(this.router.routes()),Object.assign(this.context,this.helpers),this.__initialized=!0,this.listen&&(this.appTimeout=setTimeout(this.__timeout,1e9)),this}stop(){clearTimeout(this.appTimeout)}execute(t,e){e(t).catch(t.error)}createContext(t){return this.context=Object.assign(Object.create(this.context),{path:t,app:this}),Object.create(this.context)}callback(){let t=e.createCompose(this.middleware);return(r,i,s)=>{const o=this.createContext(r);if(s){s.__pathStory.add(s.path);for(let t in s)s.hasOwnProperty(t)&&(o[t]=s[t]);t=e.createCompose(this.middleware.filter(t=>!!t.router)),o.restore(s.store())}o.set("data",i),this.execute(o,t)}}process(...t){return this.router.process(...t),this}use(t){if("function"!=typeof t)throw new TypeError("middleware must be a function.");return this.middleware.push(t),this}reload(){return this.handler=this.callback(),this}send(t,e,r){if(!this.handler||!this.__initialized)throw new Error("Application is not initialized.");return this.handler(t,e,r),this}helper(t,e){if(!t.name)throw new Error("Helper must be named FunctionDeclaration.");if("function"==typeof this.helpers[t.name])throw new Error("Helper with this named already declared.");return this.helpers[t.name]=e?t.bind(e):t,this}static createCompose(t){if(!Array.isArray(t))throw new TypeError("Argument should be an array");if(t.some(t=>"function"!=typeof t))throw new TypeError("Collection should be an array of functions.");return function(e,r){let i=-1;return function s(o){if(o<=i)return Promise.reject(new Error("Function next() called multiple times"));i=o;let n=t[o];o===t.length&&(n=r);if(!n)return e.__pathStory.clear(),Promise.resolve();try{if(!e.app.options.ignoreCyclicError&&e.__pathStory.has(e.path))throw new Error("Cyclic calling with same `path`: `".concat(e.path,"`, be careful"));const t=s.bind(null,o+1);return e.next=t,Promise.resolve(n(e,t))}catch(t){return e.__pathStory.clear(),Promise.reject(t)}}(0)}}}t.Application=e}(Application=exports.Application||(exports.Application={}));
//# sourceMappingURL=../maps/lib/Application.class.js.map
